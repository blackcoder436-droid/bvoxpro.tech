<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admins Management</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif; background:#0d1117; color:#e6edf3; padding:24px; }
    .container { max-width:1200px; margin:0 auto; }
    .header-bar { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:32px; background:#0f1720; border:1px solid #22272b; border-radius:8px; padding:16px 24px; flex-wrap:wrap; }
    .back-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:6px; background:transparent; border:1px solid #30363d; color:#e6edf3; text-decoration:none; font-size:18px; transition:all .2s; }
    .back-btn:hover { background:#30363d; border-color:#58a6ff; }
    .header-title { flex:1; text-align:center; font-size:20px; font-weight:600; color:#e6edf3; }
    .header-actions { display:flex; gap:8px; align-items:center; }
    .header-actions button { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-weight:600; font-size:14px; height:36px; display:inline-flex; align-items:center; }
    .card { background:#0f1720; border:1px solid #22272b; border-radius:8px; padding:24px; margin-bottom:24px; }
    .card-title { font-size:16px; font-weight:600; color:#e6edf3; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
    .table-wrapper { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#0d1117; }
    th { background:#161b22; border-bottom:2px solid #30363d; padding:14px 12px; text-align:left; font-size:12px; font-weight:600; color:#8b949e; text-transform:uppercase; letter-spacing:0.5px; }
    td { padding:14px 12px; border-bottom:1px solid #30363d; font-size:14px; color:#e6edf3; }
    tr:hover { background:#161b22; }
    .admin-id { color:#58a6ff; font-weight:600; }
    .status-badge { display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:500; text-transform:capitalize; }
    .status-badge.active { background:rgba(40,167,69,0.2); color:#3fb950; }
    .status-badge.inactive { background:rgba(248,81,73,0.2); color:#f85149; }
    .action-btn { display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:4px; border:1px solid #30363d; background:transparent; color:#f85149; cursor:pointer; font-size:14px; transition:all .2s; }
    .action-btn:hover { background:#f85149; color:#fff; border-color:#f85149; }
    .empty { padding:40px 20px; text-align:center; color:#8b949e; font-size:16px; }
    .muted { color:#8b949e; font-size:13px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Bar -->
    <div class="header-bar">
      <a href="dashboard.html" class="back-btn" id="topBack" title="Back to Dashboard">‚Üê</a>
      <h1 class="header-title">Admin Accounts</h1>
      <div class="header-actions">
        <!-- Placeholder for future actions -->
      </div>
    </div>

    <!-- Content Area -->
    <div class="card">
      <div class="card-title">üõ†Ô∏è Admins List</div>
      <div id="list" class="table-wrapper">
        <p class="muted">Loading admins‚Ä¶</p>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const token = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
      
      // Verify token before loading
      if(!token) { window.location.href='login.html'; return; }
      
      try{
        const parts = token.split('.');
        if(parts.length!==3) throw new Error('Invalid token format');
        const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
        if(!payload || !payload.exp || payload.exp < Math.floor(Date.now()/1000)) throw new Error('Token expired');
      }catch(e){ 
        localStorage.removeItem('adminToken'); sessionStorage.removeItem('adminToken'); 
        window.location.href='login.html'; 
        return;
      }

      function renderTable(admins){
        if(!admins || admins.length===0){
          document.getElementById('list').innerHTML = '<div class="empty">No admin records found.</div>';
          return;
        }
        let html = '<table><thead><tr><th>ID</th><th>Full Name</th><th>Username</th><th>Email</th><th>Status</th><th>Created</th><th>Last Login</th><th>Action</th></tr></thead><tbody>';
        admins.forEach(a=>{
          const status = (a.status||'active').toLowerCase();
          const statusClass = status === 'active' ? 'active' : 'inactive';
          html += `<tr>
            <td><span class="admin-id">${a.id||'-'}</span></td>
            <td>${a.fullname||'-'}</td>
            <td>${a.username||'-'}</td>
            <td>${a.email||'-'}</td>
            <td><span class="status-badge ${statusClass}">${status}</span></td>
            <td>${a.created_at ? new Date(a.created_at).toLocaleDateString() : '-'}</td>
            <td>${a.lastLogin ? new Date(a.lastLogin).toLocaleDateString() : 'Never'}</td>
            <td><button class="action-btn" onclick="deleteAdmin('${a.id}')" title="Delete admin">üóëÔ∏è</button></td>
          </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('list').innerHTML = html;
      }

      // Delete admin function
      window.deleteAdmin = function(adminId) {
        if (!confirm(`Are you sure you want to delete admin ${adminId}? This action cannot be undone.`)) return;
        
        const token = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
        fetch(`/api/admin/delete/${adminId}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        }).then(r=>{
          if(!r.ok) throw new Error('Failed to delete admin');
          return r.json();
        }).then(data=>{
          if(data.success){
            alert(`Admin ${adminId} deleted successfully.`);
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Failed to delete admin'));
          }
        }).catch(err=>{
          console.error('Error:', err);
          alert('Error deleting admin: ' + err.message);
        });
      };

      // Call secure /api/admin/list endpoint
      fetch('/api/admin/list', {
        headers: { 'Authorization': 'Bearer ' + token }
      }).then(r=>{
        if(!r.ok) throw new Error('Failed to load admins (HTTP '+r.status+')');
        return r.json();
      }).then(data=>{
        if(!data.success || !data.admins){
          throw new Error('Invalid response from server');
        }
        renderTable(data.admins);
      }).catch(err=>{
        console.error('Error:', err);
        document.getElementById('list').innerHTML = '<p class="muted">Error loading admins: '+(err.message||err)+'</p>';
      });

      document.addEventListener('keydown', e=>{ if(e.key==='Escape') window.location.href='dashboard.html'; });
    })();
  </script>
</body>
</html>